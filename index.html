<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>脚本转换测试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        textarea { width: 100%; height: 150px; margin-bottom: 10px; }
        button { padding: 10px 20px; margin-right: 10px; margin-bottom: 20px; }
        #logs { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; height: 150px; overflow: auto; margin-top: 20px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>脚本转换测试页面</h1>
    
    <h2>输入脚本内容</h2>
    <textarea id="input" placeholder="粘贴QuantumultX脚本内容到这里...">https://raw.githubusercontent.com/Mikephie/Script/main/qx/axs.js</textarea>
    
    <div>
        <button onclick="convertToLoon()">转换为Loon格式</button>
        <button onclick="convertToSurge()">转换为Surge格式</button>
        <button onclick="clearAll()">清空</button>
    </div>
    
    <h2>转换结果</h2>
    <textarea id="output" readonly></textarea>
    
    <h2>执行日志</h2>
    <div id="logs"></div>
    
    <script>
        // 添加日志功能
        function log(message) {
            const logsEl = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logsEl.innerHTML += `[${time}] ${message}<br>`;
            logsEl.scrollTop = logsEl.scrollHeight; // 自动滚动到底部
            console.log(message);
        }
        
        // 转换为Loon格式
        function convertToLoon() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            
            log(`开始转换为Loon格式...`);
            log(`输入内容: ${input.substring(0, 50)}${input.length > 50 ? '...' : ''}`);
            
            if (!input.trim()) {
                log(`错误: 输入内容为空`);
                alert('请输入脚本内容');
                return;
            }
            
            // 检测输入类型
            const isUrl = input.trim().startsWith('http') && !input.includes('\n');
            log(`输入类型: ${isUrl ? 'URL链接' : '脚本内容'}`);
            
            if (isUrl) {
                log(`处理URL: ${input}`);
                // 对于URL，我们保持不变
                output.value = input;
                log(`URL保持不变`);
                return;
            }
            
            // 转换逻辑
            log(`应用Loon转换规则...`);
            let result = input;
            
            // 记录原始内容
            log(`转换前: ${result.substring(0, 100)}${result.length > 100 ? '...' : ''}`);
            
            // 处理主机名
            const hostnameRegex = /hostname\s*=\s*(.*)/;
            if (hostnameRegex.test(result)) {
                log(`找到hostname, 应用替换...`);
                result = result.replace(hostnameRegex, 'hostname = $1');
            } else {
                log(`未找到hostname`);
            }
            
            // 处理脚本规则
            const scriptRegex = /^(https?:\/\/[^\s]+)\s+url\s+script-([a-z-]+)\s+([^\s]+)(.*)$/gm;
            if (result.match(scriptRegex)) {
                log(`找到脚本规则, 应用替换...`);
                result = result.replace(scriptRegex, 'http-$2 $1 script-path=$3$4');
            } else {
                log(`未找到脚本规则`);
            }
            
            // 处理reject规则
            const rejectRegex = /^(https?:\/\/[^\s]+)\s+url\s+reject(-.*)?$/gm;
            if (result.match(rejectRegex)) {
                log(`找到reject规则, 应用替换...`);
                result = result.replace(rejectRegex, 'http-request $1 reject$2');
            } else {
                log(`未找到reject规则`);
            }
            
            log(`转换后: ${result.substring(0, 100)}${result.length > 100 ? '...' : ''}`);
            output.value = result;
            log(`转换完成`);
        }
        
        // 转换为Surge格式
        function convertToSurge() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            
            log(`开始转换为Surge格式...`);
            log(`输入内容: ${input.substring(0, 50)}${input.length > 50 ? '...' : ''}`);
            
            if (!input.trim()) {
                log(`错误: 输入内容为空`);
                alert('请输入脚本内容');
                return;
            }
            
            // 检测输入类型
            const isUrl = input.trim().startsWith('http') && !input.includes('\n');
            log(`输入类型: ${isUrl ? 'URL链接' : '脚本内容'}`);
            
            if (isUrl) {
                log(`处理URL: ${input}`);
                // 对于URL，我们保持不变
                output.value = input;
                log(`URL保持不变`);
                return;
            }
            
            // 转换逻辑
            log(`应用Surge转换规则...`);
            let result = input;
            
            // 记录原始内容
            log(`转换前: ${result.substring(0, 100)}${result.length > 100 ? '...' : ''}`);
            
            // 处理主机名
            const hostnameRegex = /hostname\s*=\s*(.*)/;
            if (hostnameRegex.test(result)) {
                log(`找到hostname, 应用替换...`);
                result = result.replace(hostnameRegex, 'hostname = %APPEND% $1');
            } else {
                log(`未找到hostname`);
            }
            
            // 处理脚本规则
            const scriptRegex = /^(https?:\/\/[^\s]+)\s+url\s+script-([a-z-]+)\s+([^\s]+)(.*)$/gm;
            if (result.match(scriptRegex)) {
                log(`找到脚本规则, 应用替换...`);
                result = result.replace(scriptRegex, '$2 $1 script-path=$3$4');
            } else {
                log(`未找到脚本规则`);
            }
            
            // 处理reject规则
            const rejectRegex = /^(https?:\/\/[^\s]+)\s+url\s+reject(-.*)?$/gm;
            if (result.match(rejectRegex)) {
                log(`找到reject规则, 应用替换...`);
                result = result.replace(rejectRegex, 'URL-REGEX $1 reject$2');
            } else {
                log(`未找到reject规则`);
            }
            
            log(`转换后: ${result.substring(0, 100)}${result.length > 100 ? '...' : ''}`);
            output.value = result;
            log(`转换完成`);
        }
        
        function clearAll() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            document.getElementById('logs').innerHTML = '';
            log('已清空所有内容');
        }
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('页面已加载，准备转换');
        });
    </script>
</body>
</html>
