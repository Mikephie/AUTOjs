<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>脚本转换工具</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; }
        button { padding: 10px 20px; margin-right: 10px; }
        .script-list { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .script-item { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>脚本转换工具</h1>
    
    <div id="scriptList" class="script-list">
        <!-- 脚本列表将在这里显示 -->
        <p>加载脚本列表中...</p>
    </div>
    
    <h2>输入脚本内容</h2>
    <textarea id="input" placeholder="粘贴QuantumultX脚本内容到这里..."></textarea>
    
    <div>
        <button onclick="convertToLoon()">转换为Loon格式</button>
        <button onclick="convertToSurge()">转换为Surge格式</button>
        <button onclick="clearAll()">清空</button>
    </div>
    
    <h2>转换结果</h2>
    <textarea id="output" readonly></textarea>
    
    <script>
        // 配置
        const config = {
            owner: 'Mikephie', 
            repo: 'AUTOjs',
            branch: 'main',
            inputDir: 'input'
        };
        
        // 转换函数
        function convertToLoon() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            
            if (!input.trim()) {
                alert('请输入脚本内容');
                return;
            }
            
            // 转换逻辑
            let result = input;
            
            // 处理主机名
            result = result.replace(/hostname\s*=\s*(.*)/, 'hostname = $1');
            
            // 处理脚本规则
            result = result.replace(/^(https?:\/\/[^\s]+)\s+url\s+script-([a-z-]+)\s+([^\s]+)(.*)$/gm, 
                                   'http-$2 $1 script-path=$3$4');
            
            // 处理reject规则
            result = result.replace(/^(https?:\/\/[^\s]+)\s+url\s+reject(-.*)?$/gm, 
                                   'http-request $1 reject$2');
            
            output.value = result;
        }
        
        function convertToSurge() {
            const input = document.getElementById('input').value;
            const output = document.getElementById('output');
            
            if (!input.trim()) {
                alert('请输入脚本内容');
                return;
            }
            
            // 转换逻辑
            let result = input;
            
            // 处理主机名
            result = result.replace(/hostname\s*=\s*(.*)/, 'hostname = %APPEND% $1');
            
            // 处理脚本规则
            result = result.replace(/^(https?:\/\/[^\s]+)\s+url\s+script-([a-z-]+)\s+([^\s]+)(.*)$/gm, 
                                   '$2 $1 script-path=$3$4');
            
            // 处理reject规则
            result = result.replace(/^(https?:\/\/[^\s]+)\s+url\s+reject(-.*)?$/gm, 
                                   'URL-REGEX $1 reject$2');
            
            output.value = result;
        }
        
        function clearAll() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
        }
        
        // 简化脚本列表加载 - 无异步操作
        document.addEventListener('DOMContentLoaded', function() {
            const scriptListEl = document.getElementById('scriptList');
            
            // 使用GET参数控制是否加载脚本列表，避免不必要的网络请求
            const urlParams = new URLSearchParams(window.location.search);
            const shouldLoadList = urlParams.get('loadList') !== 'false';
            
            if (!shouldLoadList) {
                scriptListEl.innerHTML = '<p>脚本列表已禁用</p>';
                return;
            }
            
            scriptListEl.innerHTML = '<p>点击下方按钮加载脚本列表</p><button onclick="loadScriptList()">加载脚本列表</button>';
        });
        
        // 独立函数，仅在用户请求时加载
        function loadScriptList() {
            const scriptListEl = document.getElementById('scriptList');
            scriptListEl.innerHTML = '<p>加载中...</p>';
            
            // 设置请求超时
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时
            
            fetch(`https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.inputDir}?ref=${config.branch}`, {
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error('加载失败');
                return response.json();
            })
            .then(files => {
                // 过滤出 .js 文件
                const scriptFiles = files.filter(file => file.name.endsWith('.js'));
                
                if (scriptFiles.length === 0) {
                    scriptListEl.innerHTML = '<p>没有找到脚本文件</p>';
                    return;
                }
                
                let html = '';
                scriptFiles.forEach(file => {
                    const name = file.name.replace('.js', '');
                    html += `
                        <div class="script-item">
                            <div>${name}</div>
                            <a href="https://raw.githubusercontent.com/${config.owner}/${config.repo}/${config.branch}/${config.inputDir}/${file.name}" target="_blank">查看</a>
                        </div>
                    `;
                });
                
                scriptListEl.innerHTML = html;
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Error:', error);
                scriptListEl.innerHTML = `<p>加载失败: ${error.message}</p><button onclick="loadScriptList()">重试</button>`;
            });
        }
    </script>
</body>
</html>
