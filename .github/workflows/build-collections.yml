name: Build mcollection (Surge & Loon)

on:
  # 上游工作流成功完成后触发
  workflow_run:
    workflows: ["自动脚本转换与更新列表"]
    types: [completed]

  # 接收 cron-dispatch 发来的 repository_dispatch
  repository_dispatch:
    types: [kick_mcollection]

  # 目录级 push 触发（新增/修改/删除）
  push:
    paths:
      - 'surge/**'
      - 'loon/**'
      - 'quantumultx/**'       # ← 新增
      - 'scripts/**'
      - '.github/workflows/build-mcollection.yml'

  # 手动兜底
  workflow_dispatch: {}

permissions:
  contents: write

# 防并发：按分支+事件类型分组，避免互相取消
concurrency:
  group: build-mcollection-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  build:
    # 仅当 workflow_run 且上游成功时才执行；其它触发（dispatch/push/手动）照常执行
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Print trigger & time (debug)
        run: |
          echo "event_name=${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "upstream status: ${{ github.event.workflow_run.conclusion }}"
          fi
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "client_payload: ${{ toJson(github.event.client_payload) }}"
          fi
          echo "UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "SGT: $(TZ=Asia/Singapore date '+%Y-%m-%d %H:%M:%S')"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Surge mcollection
        run: node scripts/build-collection-surge.js

      - name: Build Loon mcollection
        run: node scripts/build-collection-loon.js

      - name: Build Quantumult X mcollection
        run: node scripts/build-collection-qx.js

      - name: Commit & Push if changed
        run: |
          set -e
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add surge/mcollection.sgmodule || true
            git add loon/mcollection.plugin    || true
            git add quantumultx/mcollection.conf || true
            git commit -m "chore: auto-build mcollection ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))"
            git push
          else
            echo "No changes to commit."
          fi