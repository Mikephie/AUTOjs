name: å®‰å…¨çš„JSæ–‡ä»¶å¤„ç†å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      remote_base_url:
        description: 'è¿œç¨‹åŸºç¡€URL'
        required: false
        default: 'https://raw.githubusercontent.com/Mikephie/AUTOjs/main/quantumultx'
      process_all:
        description: 'å¤„ç†æ‰€æœ‰æ–‡ä»¶(åŒ…æ‹¬éžJSæ–‡ä»¶)'
        required: false
        default: 'false'

  push:
    paths:
      - '**.js'
      - 'input/**'

  schedule:
    - cron: '0 3 * * *'

env:
  REMOTE_BASE_URL: 'https://raw.githubusercontent.com/Mikephie/AUTOjs/main/quantumultx'
  PROCESS_ALL: 'false'

jobs:
  process_js_files:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: è®¾ç½®å‚æ•°
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "REMOTE_BASE_URL=${{ github.event.inputs.remote_base_url }}" >> $GITHUB_ENV
            echo "PROCESS_ALL=${{ github.event.inputs.process_all }}" >> $GITHUB_ENV
          fi

      - name: å‡†å¤‡ç›®å½•
        run: mkdir -p quantumultx input

      - name: å¤åˆ¶ JS è„šæœ¬æ–‡ä»¶
        run: |
          echo "æŸ¥æ‰¾å’Œå¤åˆ¶ JS è„šæœ¬æ–‡ä»¶..."
          find input -name "*.js" -not -path "./node_modules/*" -not -path "./.git/*" > js_files.txt

          if [ ! -s js_files.txt ]; then
            echo "inputç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½• JS æ–‡ä»¶"
          else
            while read js_file; do
              filename=$(basename "$js_file")
              cp "$js_file" "quantumultx/$filename"
            done < js_files.txt
          fi

      - name: æŸ¥æ‰¾é…ç½®æ–‡ä»¶
        run: |
          > config_files.txt
          find input -type f \( -name "*.conf" -o -name "*.txt" -o -name "*.js" \) > config_files.txt

      - name: å®‰å…¨å¤„ç†é…ç½®æ–‡ä»¶
        run: |
          if [ ! -s config_files.txt ]; then
            echo "æ²¡æœ‰é…ç½®æ–‡ä»¶éœ€è¦å¤„ç†"
            exit 0
          fi

          while read config_file; do
            filename=$(basename "$config_file")
            output_file="quantumultx/$filename"
            if grep -q "\[rewrite_local\]" "$config_file"; then
              cp "$config_file" "$output_file"

              awk '
              /script-(response|request)-body/ {
                match($0, /(script-(response|request)-body[[:space:]]+)([^[:space:]]+)/, parts);
                if (parts[3]) {
                  split(parts[3], path_parts, "/");
                  script_name = path_parts[length(path_parts)];
                  remote_url = "'"$REMOTE_BASE_URL"'/" script_name;
                  sub(parts[3], remote_url);
                  print "å·²æ›¿æ¢: " parts[3] " -> " remote_url > "/dev/stderr";
                }
              }
              { print }
              ' "$output_file" > "$output_file.tmp" && mv "$output_file.tmp" "$output_file"
            fi
          done < config_files.txt

      - name: å¤„ç† quantumultx é…ç½®æ–‡ä»¶
        run: |
          find quantumultx -type f \( -name "*.conf" -o -name "*.txt" \) > qx_configs.txt
          if [ ! -s qx_configs.txt ]; then exit 0; fi

          while read config_file; do
            awk '
            /script-(response|request)-body/ {
              match($0, /(script-(response|request)-body[[:space:]]+)([^[:space:]]+)/, parts);
              if (parts[3] ~ /^\.\/|^\/|^[^\/]+\//) {
                split(parts[3], path_parts, "/");
                script_name = path_parts[length(path_parts)];
                remote_url = "'"$REMOTE_BASE_URL"'/" script_name;
                sub(parts[3], remote_url);
                print "å·²æ›¿æ¢: " parts[3] " -> " remote_url > "/dev/stderr";
              }
            }
            { print }
            ' "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
          done < qx_configs.txt

      - name: æ˜¾ç¤ºå¤„ç†ç»“æžœ
        run: |
          echo "quantumultx ç›®å½•å†…å®¹:"
          ls -la quantumultx/
          echo "è„šæœ¬å¼•ç”¨:"
          grep -r "script-.*-body" quantumultx/ || echo "æœªæ‰¾åˆ°è„šæœ¬å¼•ç”¨"
          echo "è¿œç¨‹URLå¼•ç”¨:"
          grep -r "$REMOTE_BASE_URL" quantumultx/ || echo "æœªæ‰¾åˆ°è¿œç¨‹URLå¼•ç”¨"

      - name: æäº¤å¹¶æŽ¨é€æ›´æ”¹
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          git add quantumultx/
          git commit -m "è‡ªåŠ¨å¤„ç†: JSæ–‡ä»¶å’Œè„šæœ¬å¼•ç”¨" || echo "âš ï¸ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"

          echo "ðŸ“¥ æ‹‰å–è¿œç¨‹æ›´æ”¹é¿å…å†²çª..."
          git pull --rebase --autostash || {
            echo "â— rebase å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹ä»¥é˜²å†²çª";
            exit 1;
          }

          echo "ðŸ“¤ æŽ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push || {
            echo "â— æŽ¨é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦äººå·¥å¤„ç†";
            exit 1;
          }
