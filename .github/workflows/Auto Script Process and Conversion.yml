name: è‡ªåŠ¨è„šæœ¬è½¬æ¢ä¸æ›´æ–°åˆ—è¡¨

on:
  workflow_dispatch:
  push:
    paths:
      - 'input/**'
      - 'scripts/**'
      - 'index.js'
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ

jobs:
  convert-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§± è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ—‚ï¸ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p input quantumultx loon surge

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm install

      - name: ğŸ§© å¤„ç† input â†’ quantumultx
        run: |
          echo "æŸ¥æ‰¾ JS æ–‡ä»¶å¹¶å¤åˆ¶åˆ° quantumultx/"
          find input -type f -name "*.js" | while read file; do
            cp "$file" "quantumultx/$(basename "$file")"
          done

          echo "æŸ¥æ‰¾é…ç½®æ–‡ä»¶å¹¶å¤„ç†è„šæœ¬å¼•ç”¨"
          find input -type f \( -name "*.conf" -o -name "*.txt" -o -name "*.js" \) | while read file; do
            fname=$(basename "$file")
            ofile="quantumultx/$fname"

            cp "$file" "$ofile"

            awk '
            /script-(response|request)-body/ {
              match($0, /(script-(response|request)-body\s+)([^ \n]+)/, parts);
              if (parts[3]) {
                split(parts[3], path_parts, "/");
                script_name = path_parts[length(path_parts)];
                remote_url = "https://raw.githubusercontent.com/Mikephie/AUTOjs/main/quantumultx/" script_name;
                sub(parts[3], remote_url);
                print "ğŸ“ æ›¿æ¢: " parts[3] " -> " remote_url > "/dev/stderr";
              }
            }
            /script-(response|request)-header/ {
              match($0, /(script-(response|request)-header\s+)([^ \n]+)/, parts);
              if (parts[3]) {
                split(parts[3], path_parts, "/");
                script_name = path_parts[length(path_parts)];
                remote_url = "https://raw.githubusercontent.com/Mikephie/AUTOjs/main/quantumultx/" script_name;
                sub(parts[3], remote_url);
                print "ğŸ“ æ›¿æ¢: " parts[3] " -> " remote_url > "/dev/stderr";
              }
            }
            { print }
            ' "$ofile" > "$ofile.tmp" && mv "$ofile.tmp" "$ofile"
          done

      - name: ğŸš€ è½¬æ¢ quantumultx â†’ loon/surge
        run: node index.js
        env:
          INPUT_DIR: 'quantumultx'
          OUTPUT_FORMAT: 'loon,surge'

      - name: ğŸ“„ ç”Ÿæˆ scripts.json
        run: |
          node scripts/generate-script-list.js
          echo "ğŸ“ æ£€æŸ¥ç”Ÿæˆæ–‡ä»¶:"
          ls -l scripts.json || echo "scripts.json ä¸å­˜åœ¨"

      - name: ğŸ“¤ æäº¤æ‰€æœ‰æ›´æ”¹
        run: |
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"

          git add quantumultx/ loon/ surge/ scripts.json
          git commit -m "ğŸ› ï¸ è‡ªåŠ¨è½¬æ¢ä¸æ›´æ–°è„šæœ¬åˆ—è¡¨ $(date '+%Y-%m-%d %H:%M:%S')" || echo "âš ï¸ æ— éœ€æäº¤"
          git pull --no-rebase || echo "âš ï¸ æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
          git push || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†"
