name: è‡ªåŠ¨è„šæœ¬è½¬æ¢ä¸æ›´æ–°åˆ—è¡¨

on:
  workflow_dispatch:
  push:
    paths:
      - 'input/**'
      - 'scripts/**'
      - 'index.js'
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ

jobs:
  convert-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§± è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ§° å®‰è£… gawkï¼ˆç”¨äºæ›´ç¨³çš„ awk ç‰¹æ€§ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y gawk

      - name: ğŸ—‚ï¸ åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p input quantumultx loon surge

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ğŸ§¹ æ¸…ç†æ—§çš„ conf/txtï¼ˆé¿å…é—ç•™å¹²æ‰°ï¼‰
        run: |
          rm -f quantumultx/*.conf quantumultx/*.txt || true

      - name: ğŸ§© å¤„ç† input â†’ quantumultx
        run: |
          echo "æŸ¥æ‰¾ JS æ–‡ä»¶å¹¶å¤åˆ¶åˆ° quantumultx/"
          find input -type f -name "*.js" | while read file; do
            cp "$file" "quantumultx/$(basename "$file")"
          done

          echo "æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼ˆ.conf/.txtï¼‰å¹¶è§„èŒƒè„šæœ¬å¼•ç”¨ URL"
          find input -type f \( -name "*.conf" -o -name "*.txt" \) | while read file; do
            fname=$(basename "$file")
            ofile="quantumultx/$fname"

            # å¤åˆ¶åˆ°ç›®æ ‡ç›®å½•
            cp "$file" "$ofile"

            # ç»Ÿä¸€è§„èŒƒè„šæœ¬ URL åˆ° AUTOjs/quantumultx/<æ–‡ä»¶å>
            gawk -v base="https://raw.githubusercontent.com/Mikephie/AUTOjs/main/quantumultx" '
BEGIN { IGNORECASE = 1 }
{
  line = $0
  # åŒè¡Œå¯èƒ½å¤šå¤„å‘½ä¸­ï¼šé€ä¸€æ›¿æ¢
  while (match(line, /(url[[:space:]]+script-(response-body|request-body|request-header)[[:space:]]+)([^[:space:]]+)/, m)) {
    target = m[3]

    # å»é™¤ query/fragment
    gsub(/\?.*$/, "", target)
    gsub(/#.*/, "", target)

    # å–è„šæœ¬æ–‡ä»¶å
    n = split(target, a, "/")
    fname = a[n]

    if (fname == "") { break }

    newurl = base "/" fname

    # è¾“å‡ºæ›¿æ¢æ—¥å¿—åˆ° stderr
    print "ğŸ“ æ›¿æ¢: " target " -> " newurl > "/dev/stderr"

    # æ‹¼å›æœ¬æ¬¡æ›¿æ¢ï¼Œå¹¶ç»§ç»­ while å¤„ç†åç»­å‘½ä¸­
    pre  = substr(line, 1, RSTART-1)
    post = substr(line, RSTART + RLENGTH)
    line = pre m[1] newurl post
  }

  print line
}
' "$ofile" > "$ofile.tmp" && mv "$ofile.tmp" "$ofile"
          done

      - name: ğŸš€ è½¬æ¢ quantumultx â†’ loon/surge
        run: node index.js
        env:
          INPUT_DIR: 'quantumultx'
          OUTPUT_FORMAT: 'loon,surge'

      - name: ğŸ“„ ç”Ÿæˆ scripts.json
        run: |
          node scripts/generate-script-list.js
          echo "ğŸ“ æ£€æŸ¥ç”Ÿæˆæ–‡ä»¶:"
          ls -l scripts.json || echo "scripts.json ä¸å­˜åœ¨"

      - name: ğŸ“¤ æäº¤æ‰€æœ‰æ›´æ”¹
        run: |
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"

          git add quantumultx/ loon/ surge/ scripts.json
          git commit -m "ğŸ› ï¸ è‡ªåŠ¨è½¬æ¢ä¸æ›´æ–°è„šæœ¬åˆ—è¡¨ $(date '+%Y-%m-%d %H:%M:%S')" || echo "âš ï¸ æ— éœ€æäº¤"
          git pull --no-rebase || echo "âš ï¸ æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
          git push || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†"
